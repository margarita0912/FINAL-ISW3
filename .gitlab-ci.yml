variables:
  GO_VERSION: "1.24"
  FRONTEND_DIR: "ventas-frontend"
  BACKEND_DIR: "ventas-app"

stages:
  - test_backend
  - test_frontend
  - build_backend
  - build_frontend
  - sonarcloud_analysis
  - e2e_tests

# --------------------------
# Build backend (Go)
# --------------------------
build_backend:
  stage: build_backend
  image: golang:${GO_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - go version
    - go mod tidy
    - go build -o ../backend-app ./cmd/main.go
  artifacts:
    paths:
      - backend-app
    expire_in: 1 hour

# --------------------------
# Build frontend (React - Vite)
# --------------------------
build_frontend:
  stage: build_frontend
  image: node:20
  needs:
    - job: test_frontend
      artifacts: true
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${FRONTEND_DIR}/node_modules/
  script:
    - cd ${FRONTEND_DIR}
    - npm ci
    - npm run build
  artifacts:
    paths:
      - ${FRONTEND_DIR}/dist
    expire_in: 1 hour

# --------------------------
# Test backend (Go + Coverage + JUnit)
# --------------------------
test_backend:
  stage: test_backend
  image: golang:${GO_VERSION}
  needs: []
  script:
    - cd ${BACKEND_DIR}
    - go version
    - go mod tidy
    - echo "ðŸ“¦ Instalando dependencias necesarias..."
    - go install gotest.tools/gotestsum@latest
    - go install github.com/boumenot/gocover-cobertura@latest
    - echo "ðŸ§ª Ejecutando tests con cobertura..."
    - go test ./... -v -coverprofile=coverage.out -covermode=atomic || true
    - echo "ðŸ“Š Generando reporte Cobertura XML..."
    - gocover-cobertura < coverage.out > coverage.xml
    - echo "ðŸ§© Generando reporte JUnit XML (para GitLab)..."
    - gotestsum --junitfile report.xml --format short-verbose -- -v ./... || true
    - echo "âœ… Archivos generados:"
    - ls -la
  artifacts:
    when: always
    reports:
      junit: ${BACKEND_DIR}/report.xml   
    paths:
      - ${BACKEND_DIR}/coverage.xml      
      - ${BACKEND_DIR}/report.xml
    expire_in: 1 day
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'

# --------------------------
# Test frontend (Jest + JUnit XML)
# --------------------------
test_frontend:
  stage: test_frontend
  image: node:20
  needs:
    - job: test_backend
      artifacts: true
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${FRONTEND_DIR}/node_modules/
  script:
    - cd ${FRONTEND_DIR}
    - npm ci
    - echo "âš™ï¸ Ejecutando pruebas Jest con cobertura y reporte XML..."
    - npm run test:ci || true
  artifacts:
    when: always
    reports:
      junit: ${FRONTEND_DIR}/coverage/junit.xml
    paths:
      - ${FRONTEND_DIR}/coverage/
    expire_in: 1 day
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

# --------------------------
# AnÃ¡lisis estÃ¡tico con SonarCloud
# --------------------------
sonarcloud_analysis:
  stage: sonarcloud_analysis
  needs:
    - job: test_backend
      artifacts: true
    - job: test_frontend
      artifacts: true
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - echo "ðŸ“ Verificando archivos de coverage..."
    - ls -la ${BACKEND_DIR}/ || true
    - echo "ðŸ“Š Verificando coverage XML del backend..."
    - if [ -f "${BACKEND_DIR}/coverage.xml" ]; then echo "âœ… coverage.xml encontrado"; head -3 ${BACKEND_DIR}/coverage.xml || true; else echo "âŒ coverage.xml no encontrado"; fi
    - echo "ðŸ“Š Verificando coverage LCOV del frontend..."
    - if [ -f "${FRONTEND_DIR}/coverage/lcov.info" ]; then echo "âœ… lcov.info encontrado"; else echo "âŒ lcov.info no encontrado"; fi
    - echo "ðŸ” Ejecutando anÃ¡lisis de SonarCloud..."
    - >
      sonar-scanner
      -Dsonar.organization=$SONAR_ORG
      -Dsonar.projectKey=$SONAR_PROJECT_KEY
      -Dsonar.host.url=https://sonarcloud.io
      -Dsonar.token=$SONAR_TOKEN
      -Dsonar.sources=${BACKEND_DIR},${FRONTEND_DIR}/src
      -Dsonar.go.coverage.reportPaths=${BACKEND_DIR}/coverage.out
      -Dsonar.javascript.lcov.reportPaths=${FRONTEND_DIR}/coverage/lcov.info
      -Dsonar.exclusions=**/node_modules/**,**/vendor/**,**/cypress/**,**/*.test.js,**/*.spec.js
      -Dsonar.coverage.exclusions=**/*.out
      -Dsonar.cpd.exclusions=**/coverage/**
      -Dsonar.coverageReportPaths=""
      -Dsonar.genericCoverage.disabled=true
      -Dsonar.verbose=true
  only:
    - main
  allow_failure: true

# NOTE: QA/Prod validation jobs (smoke/acceptance) removed because QA/Prod not deployed yet.
# Re-add manual `smoke` and `acceptance` jobs when QA/PROD environments are available.
#
# The following snippet can be pasted back into this file when QA/PROD are available.
# It's commented out to keep the pipeline clean while you don't have QA/PROD deployed.
#
# --- BEGIN QA/PROD JOBS SNIPPET (commented) ---
#
# # smoke (manual)
# smoke:
#   stage: smoke
#   image: curlimages/curl:8.3.0
#   needs:
#     - job: build_backend
#       artifacts: true
#     - job: build_frontend
#       artifacts: true
#   variables:
#     QA_URL: ""
#   script:
#     - |
#       if [ -z "$QA_URL" ]; then
#         echo "ERROR: QA_URL is not set. Set QA_URL in CI variables to point to QA environment." >&2
#         exit 1
#       fi
#     - curl -sSf "$QA_URL/health" -o /dev/null
#   when: manual
#   only:
#     - main
#
# # acceptance (manual, Cypress)
# acceptance:
#   stage: acceptance
#   image: node:20
#   needs:
#     - job: build_backend
#       artifacts: true
#     - job: build_frontend
#       artifacts: true
#   variables:
#     QA_URL: ""
#   script:
#     - |
#       if [ -z "$QA_URL" ]; then
#         echo "ERROR: QA_URL is not set. Set QA_URL in CI variables to point to QA environment." >&2
#         exit 1
#       fi
#     - cd ${FRONTEND_DIR}
#     - npm ci
#     - npx cypress run --spec "cypress/e2e/acceptance.cy.js" --config baseUrl=$QA_URL --env apiUrl=$QA_URL
#   when: manual
#   only:
#     - main
#
# --- END QA/PROD JOBS SNIPPET (commented) ---

# --------------------------
# E2E Tests (Cypress)
# --------------------------
e2e_tests:
  stage: e2e_tests
  image: node:20
  needs:
    - job: build_backend
      artifacts: true
    - job: build_frontend
      artifacts: true
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libnss3 libgtk-3-0 libxss1 libgconf-2-4 libxrandr2 libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 libgdk-pixbuf2.0-0
  script:
    - cd ${FRONTEND_DIR}
    - npm ci
    - echo "Verificando instalacion de Cypress..."
    - npx cypress version
    - echo "Cypress setup verificado exitosamente"
    - echo "Para ejecutar E2E completo, configura servicios de backend/frontend"
    - echo "Pipeline completado con exito"
  artifacts:
    when: always
    paths:
      - ${FRONTEND_DIR}/cypress/videos/
      - ${FRONTEND_DIR}/cypress/screenshots/
    expire_in: 1 day
  allow_failure: true
