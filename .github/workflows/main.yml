name: CI/CD - TP8

on:
  push:
    branches: ["main", "qa"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_BACK: ghcr.io/${{ github.repository_owner }}/ventas-back
  IMAGE_FRONT: ghcr.io/${{ github.repository_owner }}/ventas-front

jobs:

  # -------------------------------------------------------------
  # 1 CHECKOUT + LOGIN GHCR
  # -------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

  # -------------------------------------------------------------
  # 2 BUILD & PUSH IMAGENES (BACK + FRONT)
  # -------------------------------------------------------------
  build_and_push:
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ------- Backend -------
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ventas-app
          file: ventas-app/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_BACK }}:latest
            ${{ env.IMAGE_BACK }}:${{ github.sha }}

      # ------- Frontend -------
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ventas-frontend
          file: ventas-frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_FRONT }}:latest
            ${{ env.IMAGE_FRONT }}:${{ github.sha }}

  # -------------------------------------------------------------
  # 3 DEPLOY QA AUTOMÁTICO EN RENDER
  # -------------------------------------------------------------
  deploy_qa:
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Deploy Backend QA
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_QA_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Deploy Frontend QA
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_QA_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

  # -------------------------------------------------------------
  # 4 GATE MANUAL ANTES DE PROD
  # -------------------------------------------------------------
  approve_prod:
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment:
      name: prod
      url: https://render.com
    steps:
      - run: echo "Esperando aprobación manual para PROD..."

  # -------------------------------------------------------------
  # 5 DEPLOY PROD (DESPUÉS DE LA APROBACIÓN)
  # -------------------------------------------------------------
  deploy_prod:
    runs-on: ubuntu-latest
    needs: approve_prod

    steps:
      - name: Deploy Backend PROD
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_PROD_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Deploy Frontend PROD
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_PROD_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}"
